# Production Deployment Guide

## Pre-Deployment Checklist

Before deploying to production, verify all requirements:

### Security
- [ ] `NODE_ENV=production` in .env
- [ ] Strong `JWT_SECRET` (min 32 chars random)
- [ ] Strong `DATABASE_PASSWORD` (min 16 chars random)
- [ ] Strong `SESSION_SECRET` (min 32 chars random)
- [ ] Redis password enabled (`REDIS_PASSWORD` set)
- [ ] `LOG_PRETTY_PRINT=false`
- [ ] `CORS_ORIGIN` with specific domains (not *)
- [ ] `DATABASE_SSL=true` if database is exposed
- [ ] Secrets stored in secret manager (not .env file)

### SSL/TLS
- [ ] Real domain in `CADDY_DOMAIN`
- [ ] Production Let's Encrypt in `CADDY_ACME_CA`
- [ ] Valid email in `CADDY_EMAIL`
- [ ] DNS records pointing to server

### OAuth
- [ ] OAuth credentials for production (not dev)
- [ ] Redirect URIs updated in OAuth provider consoles
- [ ] Apple Sign-In keys stored securely

### Infrastructure
- [ ] Health checks configured in orchestrator
- [ ] Backup strategy implemented
- [ ] Monitoring and alerting configured
- [ ] Firewall rules configured
- [ ] Log aggregation configured

## Environment Variables Reference

### Application

| Variable | Description | Required | Example |
|----------|-------------|----------|---------|
| `NODE_ENV` | Environment mode | Yes | `production` |
| `API_URL` | Application URL for OAuth redirects | Yes | `https://api.yourdomain.com` |
| `PORT` | Server port | No | `1337` (default) |
| `HOST` | Server host | No | `0.0.0.0` (default) |

### Database (PostgreSQL)

| Variable | Description | Required | Example |
|----------|-------------|----------|---------|
| `DATABASE_HOST` | Database host | Yes | `postgres` (Docker) or `localhost` |
| `DATABASE_PORT` | Database port | No | `5432` (default) |
| `DATABASE_USER` | Database username | Yes | `postgres` |
| `DATABASE_PASSWORD` | Database password | Yes | `min 16 chars random` |
| `DATABASE_NAME` | Database name | Yes | `fastify_oauth_db` |
| `DATABASE_SSL` | Enable SSL | No | `true` (if database exposed) |

### Redis

| Variable | Description | Required | Example |
|----------|-------------|----------|---------|
| `REDIS_HOST` | Redis host | Yes | `redis` (Docker) or `localhost` |
| `REDIS_PORT` | Redis port | No | `6379` (default) |
| `REDIS_PASSWORD` | Redis password | Yes (prod) | `min 16 chars random` |
| `REDIS_KEY_PREFIX` | Key prefix | No | `fastify:` (default) |

### Authentication

| Variable | Description | Required | Example |
|----------|-------------|----------|---------|
| `JWT_SECRET` | JWT signing secret | Yes | `min 32 chars random` |
| `JWT_ACCESS_TOKEN_EXPIRATION` | Access token lifetime | No | `15m` (default) |
| `JWT_REFRESH_TOKEN_EXPIRATION` | Refresh token lifetime | No | `7d` (default) |
| `SESSION_SECRET` | Session secret | Yes | `min 32 chars random` |

### OAuth Providers

| Variable | Description | Required | Example |
|----------|-------------|----------|---------|
| `GOOGLE_CLIENT_ID` | Google OAuth client ID | Yes | `123456789-abcdef.apps.googleusercontent.com` |
| `GOOGLE_CLIENT_SECRET` | Google OAuth client secret | Yes | `GOCSPX-...` |
| `GOOGLE_REDIRECT_URI` | Google OAuth callback URL | Yes | `https://api.yourdomain.com/api/auth/google/callback` |
| `APPLE_CLIENT_ID` | Apple OAuth service ID | No | `com.yourdomain.service` |
| `APPLE_TEAM_ID` | Apple Developer Team ID | No | `ABCDEF1234` |
| `APPLE_KEY_ID` | Apple Sign-In key ID | No | `ABCDEF1234` |
| `APPLE_REDIRECT_URI` | Apple OAuth callback URL | No | `https://api.yourdomain.com/api/auth/apple/callback` |

### Admin Setup

| Variable | Description | Required | Example |
|----------|-------------|----------|---------|
| `ADMIN_EMAIL` | Primary admin email | No | `admin@yourdomain.com` |
| `ADMIN_EMAILS_ADDITIONAL` | Additional admin emails | No | `admin2@yourdomain.com,admin3@yourdomain.com` |
| `SUPER_ADMIN_EMAIL` | Super admin email(s) | No | `superadmin@yourdomain.com` |

### API Keys (Generated by Setup Wizard)

| Variable | Description | Required | Example |
|----------|-------------|----------|---------|
| `IOS_API_KEY` | API key for iOS mobile app | No | Stored in mobile app |
| `ANDROID_API_KEY` | API key for Android mobile app | No | Stored in mobile app |
| `NEXT_PUBLIC_ADMIN_PANEL_API_KEY` | API key for admin panel | Yes | Generated during setup |

### Caddy (Reverse Proxy)

| Variable | Description | Required | Example |
|----------|-------------|----------|---------|
| `CADDY_DOMAIN` | Domain name | Yes | `api.yourdomain.com` |
| `CADDY_EMAIL` | Email for Let's Encrypt | Yes | `admin@yourdomain.com` |
| `CADDY_ACME_CA` | ACME CA URL | Yes | `https://acme-v02.api.letsencrypt.org/directory` |

### Logging & Security

| Variable | Description | Required | Example |
|----------|-------------|----------|---------|
| `LOG_PRETTY_PRINT` | Pretty print logs | No | `false` (production) |
| `CORS_ORIGIN` | CORS allowed origins | No | `https://yourdomain.com,https://app.yourdomain.com` |
| `SWAGGER_ENABLED` | Enable Swagger docs | No | `false` (or protect endpoint) |

### Docker Container Names

| Variable | Description | Required | Example |
|----------|-------------|----------|---------|
| `CONTAINER_POSTGRES_NAME` | PostgreSQL container name | No | `fastify-oauth-postgres` |
| `CONTAINER_REDIS_NAME` | Redis container name | No | `fastify-oauth-redis` |
| `CONTAINER_API_NAME` | API container name | No | `fastify-oauth-api` |
| `CONTAINER_CADDY_NAME` | Caddy container name | No | `fastify-oauth-caddy` |

## Deployment Steps

### 1. Server Preparation

**Install Docker:**
```bash
curl -fsSL https://get.docker.com -o get-docker.sh
sudo sh get-docker.sh
sudo usermod -aG docker $USER
```

**Install Docker Compose:**
```bash
sudo curl -L "https://github.com/docker/compose/releases/latest/download/docker-compose-$(uname -s)-$(uname -m)" -o /usr/local/bin/docker-compose
sudo chmod +x /usr/local/bin/docker-compose
```

**Configure Firewall:**
```bash
sudo ufw allow 22/tcp    # SSH
sudo ufw allow 80/tcp    # HTTP
sudo ufw allow 443/tcp   # HTTPS
sudo ufw enable
```

### 2. Application Setup

**Clone repository:**
```bash
git clone <repository-url>
cd fastify-oauth-api
```

**Create production .env:**
```bash
cp .env.production.example .env
# Edit .env with production values
nano .env
```

**Set up OAuth keys:**
```bash
# For Apple Sign-In, place AuthKey_XXXXXXXXXX.p8 in keys/ directory
mkdir -p keys
# Upload Apple AuthKey to keys/
chmod 600 keys/AuthKey_*.p8
```

### 3. Build and Deploy

**Build Docker images:**
```bash
docker compose build
```

**Start services:**
```bash
docker compose up -d
```

**Check service health:**
```bash
docker compose ps
docker compose logs -f
pnpm docker:health
```

**Run database migrations:**
```bash
docker compose exec api pnpm db:migrate
```

**Initialize setup wizard:**
```bash
# Access setup wizard at https://yourdomain.com/admin/setup
# Or run setup via API:
curl -X POST https://yourdomain.com/api/setup/initialize \
  -H "Content-Type: application/json" \
  -d '{
    "email": "superadmin@yourdomain.com",
    "name": "Super Admin"
  }'
```

**Save API keys:**
API keys are generated during setup wizard. Save them securely:
- `ios_api_key` → iOS mobile app config
- `android_api_key` → Android mobile app config
- `admin_panel_api_key` → Add to `.env` as `NEXT_PUBLIC_ADMIN_PANEL_API_KEY`

### 4. Verify Deployment

**Health check:**
```bash
curl https://yourdomain.com/health
# Expected: {"status":"ok"}
```

**Test OAuth flow:**
1. Navigate to https://yourdomain.com/admin
2. Click "Sign in with Google"
3. Complete OAuth flow
4. Verify admin panel access

**Check logs:**
```bash
docker compose logs -f api
docker compose logs -f postgres
docker compose logs -f redis
docker compose logs -f caddy
```

## Production Monitoring

### Health Checks

**API Health:**
```bash
curl https://yourdomain.com/health
```

**Docker Health:**
```bash
docker compose ps
# All services should show "healthy" status
```

**Database Health:**
```bash
docker compose exec postgres pg_isready -U postgres
```

**Redis Health:**
```bash
docker compose exec redis redis-cli -a <password> ping
# Expected: PONG
```

### Logs

**View all logs:**
```bash
docker compose logs -f
```

**View specific service:**
```bash
docker compose logs -f api
docker compose logs -f postgres
docker compose logs -f redis
docker compose logs -f caddy
```

**Export logs for analysis:**
```bash
docker compose logs --since 1h > logs.txt
```

### Metrics

Monitor these key metrics:

**Application:**
- API response times (< 100ms simple, < 500ms complex)
- Request rate (monitor rate limiting)
- Error rate (should be < 1%)
- JWT token generation/validation times

**Database:**
- Connection pool usage
- Query execution times
- Slow query log
- Database size growth

**Redis:**
- Memory usage
- Cache hit rate
- Connected clients
- Key evictions

**Infrastructure:**
- CPU usage (should be < 80%)
- Memory usage (should be < 80%)
- Disk space (should be > 20% free)
- Network I/O

## Backup & Recovery

### Database Backup

**Manual backup:**
```bash
pnpm docker:postgres:backup
# Backup saved to docker/database/backups/
```

**Automated backup (cron):**
```bash
# Add to crontab
0 2 * * * cd /path/to/fastify-oauth-api && pnpm docker:postgres:backup
```

**Backup to S3 (recommended):**
```bash
# After creating backup
aws s3 cp docker/database/backups/backup-$(date +%Y%m%d).sql.gz \
  s3://your-bucket/backups/
```

### Database Recovery

**Restore from backup:**
```bash
# Stop API
docker compose stop api

# Restore database
gunzip < docker/database/backups/backup-20250101.sql.gz | \
  docker compose exec -T postgres psql -U postgres -d fastify_oauth_db

# Restart API
docker compose start api
```

### Disaster Recovery

**Full system backup:**
1. Backup database (see above)
2. Backup Redis data: `docker compose exec redis redis-cli -a <password> BGSAVE`
3. Backup `.env` file (securely)
4. Backup OAuth keys in `keys/` directory

**Full system restore:**
1. Clone repository
2. Restore `.env` file
3. Restore OAuth keys to `keys/`
4. Build and start services
5. Restore database from backup
6. Verify all services are healthy

## Scaling

### Horizontal Scaling

**Multiple API Instances:**
```yaml
# docker-compose.yml
services:
  api:
    deploy:
      replicas: 3
    environment:
      - PORT=1337
```

**Load Balancer:**
Update Caddyfile to distribute traffic:
```
{$CADDY_DOMAIN} {
    reverse_proxy api:1337 api2:1337 api3:1337 {
        lb_policy round_robin
        health_uri /health
        health_interval 10s
    }
}
```

### Vertical Scaling

**Increase resource limits:**
```yaml
# docker-compose.yml
services:
  api:
    deploy:
      resources:
        limits:
          cpus: '4.0'
          memory: 4G
```

**Database optimization:**
```conf
# docker/database/postgresql.conf
max_connections = 200
shared_buffers = 512MB
effective_cache_size = 2GB
```

### Caching Strategy

**Redis caching for slow operations:**
```typescript
// Cache API responses
const cacheKey = `users:list:${page}:${limit}`;
const cached = await redis.get(cacheKey);
if (cached) return JSON.parse(cached);

// Fetch from database
const users = await db.query.users.findMany();

// Cache for 5 minutes
await redis.setex(cacheKey, 300, JSON.stringify(users));
```

## Security Best Practices

### SSL/TLS
- ✅ Use Let's Encrypt for automatic SSL certificates
- ✅ Redirect HTTP to HTTPS (Caddy handles this)
- ✅ Use strong cipher suites
- ✅ Enable HSTS headers

### Secrets Management
- ✅ Store secrets in environment variables
- ✅ Use secret manager (AWS Secrets Manager, HashiCorp Vault)
- ✅ Rotate secrets regularly (JWT secret, database password)
- ✅ Never commit secrets to Git

### Network Security
- ✅ Firewall: Only allow ports 22, 80, 443
- ✅ VPC: Use private network for database and Redis
- ✅ Rate limiting: 100 requests/minute per IP
- ✅ CORS: Only allow specific origins

### API Security
- ✅ Global API key authentication
- ✅ JWT tokens with short expiration (15 minutes)
- ✅ Refresh tokens with rotation
- ✅ RBAC for admin endpoints
- ✅ Input validation with Zod schemas

### Database Security
- ✅ Strong password (min 16 chars)
- ✅ SSL connections if database is exposed
- ✅ Limited user permissions
- ✅ Regular backups
- ✅ Connection pooling

## Updating the Application

### Zero-Downtime Deployment

**1. Pull latest code:**
```bash
git pull origin main
```

**2. Build new images:**
```bash
docker compose build api
```

**3. Run database migrations:**
```bash
docker compose exec api pnpm db:migrate
```

**4. Rolling update:**
```bash
# If using multiple replicas
docker compose up -d --no-deps --scale api=3 api

# If single instance
docker compose up -d api
```

**5. Verify deployment:**
```bash
curl https://yourdomain.com/health
docker compose logs -f api
```

### Rollback Procedure

**1. Revert to previous version:**
```bash
git revert HEAD
git push origin main
```

**2. Rebuild and deploy:**
```bash
docker compose build api
docker compose up -d api
```

**3. Rollback database (if needed):**
```bash
# Restore from backup before migration
# See Database Recovery section
```

## Troubleshooting Production Issues

### High CPU Usage
```bash
# Check which container is using CPU
docker stats

# Check API logs for slow queries
docker compose logs api | grep "slow"

# Restart API if needed
docker compose restart api
```

### High Memory Usage
```bash
# Check memory usage
docker stats

# Check for memory leaks in API logs
docker compose logs api | grep "memory"

# Restart service to free memory
docker compose restart api
```

### Database Connection Pool Exhausted
```bash
# Check active connections
docker compose exec postgres psql -U postgres -c \
  "SELECT count(*) FROM pg_stat_activity;"

# Increase max_connections in postgresql.conf
# Restart PostgreSQL
docker compose restart postgres
```

### Redis Out of Memory
```bash
# Check memory usage
docker compose exec redis redis-cli -a <password> INFO memory

# Check eviction policy
docker compose exec redis redis-cli -a <password> CONFIG GET maxmemory-policy

# Increase memory limit or enable eviction
```

### SSL Certificate Issues
```bash
# Check certificate expiry
docker compose exec caddy caddy list-certificates

# Force certificate renewal
docker compose exec caddy caddy reload --config /etc/caddy/Caddyfile
```

## Performance Optimization

### Database Optimization
- Index frequently-queried columns
- Use connection pooling (min: 2, max: 10)
- Analyze slow queries with EXPLAIN ANALYZE
- Regular VACUUM and ANALYZE

### API Optimization
- Enable compression (gzip)
- Use Redis caching for slow operations
- Optimize database queries
- Use connection pooling

### Frontend Optimization
- Build admin panel with `pnpm build:frontend`
- Enable static file caching in Caddy
- Use CDN for static assets (if applicable)

---

**See also:**
- [ARCHITECTURE.md](./ARCHITECTURE.md) - Project structure and tech stack
- [API.md](./API.md) - API endpoints and authentication
- [DOCKER.md](./DOCKER.md) - Docker configuration
- [DEVELOPMENT.md](./DEVELOPMENT.md) - Development workflow
